ArticleEditor.add("plugin","reorder",{defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><g fill="#000" fill-rule="nonzero"><path d="m13 5c.5522847 0 1 .44771525 1 1 0 .51283584-.3860402.93550716-.8833789.99327227l-.1166211.00672773h-10c-.55228475 0-1-.44771525-1-1 0-.51283584.38604019-.93550716.88337887-.99327227l.11662113-.00672773z"/><path d="m13 9c.5522847 0 1 .44771525 1 1 0 .5128358-.3860402.9355072-.8833789.9932723l-.1166211.0067277h-10c-.55228475 0-1-.4477153-1-1 0-.51283584.38604019-.93550716.88337887-.99327227l.11662113-.00672773z"/></g></svg>'},subscribe:{"block.set":function(){this._observe()}},init:function(){},start:function(){this.app.control.add("reorder",{icon:this.opts.reorder.icon,position:"first",blocks:{all:"first-level"}})},stop:function(){this._stopEvents()},_observe:function(){this.$btn=this.app.control.get("reorder"),0!==this.$btn.length&&(this.$btn.addClass(this.prefix+"-handle"),this._sortable())},_sortable:function(){this.instance=this.app.block.get(),this.$win=this.app.editor.getWin(),this.tolerance=this.$btn.width(),this.$clickItem=null,this.$dragItem=null,this.oldY=0,this.dragging=!1,this.$btn.on("mousedown."+this.prefix+"-reorder touchstart."+this.prefix+"-reorder",this._press.bind(this))},_press:function(t){var i=this.dom(t.target).closest("."+this.prefix+"-button");if(t&&t.target&&i.hasClass(this.prefix+"-handle")){t.preventDefault(),this.app.observer.trigger=!1,this.$win.on("mouseup."+this.prefix+"-reorder touchend."+this.prefix+"-reorder",this._release.bind(this)),this.$win.on("mousemove."+this.prefix+"-reorder touchmove."+this.prefix+"-reorder",this._move.bind(this));var e=this.instance.getBlock().get();this.app.block.unset(),this.dragging=!0,this.$dragItem=this._makeDragItem(e,t.target)}},_release:function(t){this._stopEvents(),this.app.observer.trigger=!0,this.oldY=0,this.dragging=!1,this._trashDragItem(),this.app.block.set(this.instance)},_move:function(t){if(this.$dragItem||this.dragging){t.preventDefault();var i=this.app.editor.getFrameRect(),e=!1,s=0===this.oldY?0:this.oldY-t.pageY;0<s?e="up":s<0&&(e="down");var r=this.app.scroll.isTarget(),o=this._isFrameScroll(),h=this.app.$doc.scrollTop(),a=r?this.app.scroll.getTarget():this.app.$doc,p=o?this.app.editor.getDoc().scrollTop():a.scrollTop();this._moveItem(this.$dragItem,s),this.oldY=t.pageY;var n,l=!1;r?n=a.height()+a.offset().top-40:o?(n=i.bottom-40,endWin=this.app.$win.height()+h-40,endWin<n&&(n=endWin)):(l=!this.app.toolbar.isSticky(),n=this.app.$win.height()+p-40);var c=this.app.container.get("bars"),d=c.height(),g=o?t.pageY+i.top-p:t.pageY+i.top,f=c.offset().top+d+40;"up"===e&&0<p&&g<f&&!1===l?this._scroll(-10):"down"===e&&n<g&&this._scroll(10);for(var m=this.app.editor.getLayout().children(),v=m.length,u=0;u<v;u++){var $=m.eq(u).get();$!==this.$clickItem.get()&&this._isOver(this.dom($))&&this._swapItems($)}}},_scroll:function(t){var i=this.app.scroll.isTarget()?this.app.scroll.getTarget():this.app.$win;this._isFrameScroll()&&(i=this.app.editor.getWin());var e=i.scrollTop();i.scrollTop(e+t)},_swapItems:function(t){var i=this.$dragItem.offset().top,e=this.$clickItem,s=this.dom(t),r=s.offset(),o=s.height()/2;s[o+r.top>i?"before":"after"](e)},_stopEvents:function(){this.$win&&(this.$btn.off("."+this.prefix+"-reorder"),this.$win.off("."+this.prefix+"-reorder"))},_isFrameScroll:function(){return this.app.editor.getFrame().height()<this.app.editor.getBody().height()},_isOver:function(t){var i=this.$dragItem.offset().top,e=t.offset(),s=t.height();return i>e.top&&i<e.top+s},_moveItem:function(t,i){var e=t.offset().top;e-=i,t.css("top",e+"px")},_makeDragItem:function(t){this._trashDragItem();var i=this.dom(t),e=i.offset();this.$clickItem=i,this.$clickItem.addClass(this.prefix+"-drag-active");var s=i.clone();s.removeClass(this.prefix+"-drag-active "+this.prefix+"-element-active");var r=this.dom("<div>").addClass(this.prefix+"-dragging");return r.append(s),r.css({opacity:.95,position:"absolute","z-index":999,left:e.left+"px",top:e.top+"px",width:i.width()+"px"}),this.app.editor.getBody().append(r),r},_trashDragItem:function(){this.$dragItem&&this.$clickItem&&(this.$clickItem.removeClass(this.prefix+"-drag-active"),this.$clickItem=null,this.$dragItem.remove(),this.$dragItem=null)}});